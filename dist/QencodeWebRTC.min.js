!function(e,n){"object"==typeof exports&&"object"==typeof module?module.exports=n():"function"==typeof define&&define.amd?define([],n):"object"==typeof exports?exports.QencodeWebRTC=n():e.QencodeWebRTC=n()}(self,(function(){return(()=>{"use strict";var e={d:(n,o)=>{for(var t in o)e.o(o,t)&&!e.o(n,t)&&Object.defineProperty(n,t,{enumerable:!0,get:o[t]})},o:(e,n)=>Object.prototype.hasOwnProperty.call(e,n)},n={};e.d(n,{default:()=>u});const o={},t="QencodeWebRTC.js :",c="QencodeWebRTC.js :";let i=[],r=!1;function a(e,n){e&&e.send(JSON.stringify(n))}function l(e){let n,o="";return(n=e.match(/^(?:wss?:\/\/)?(?:[^@\n]+@)?(?:www\.)?([^:\/\n\?\=]+)/im))&&(o=n[1]),o}function d(e){let n,o="";return(n=e.match(new RegExp("\\b(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\b","gi")))&&(o=n[0]),o}function s(e){function n(n){e.callbacks.error&&e.callbacks.error(n)}function o(n){const o=e.connectionConfig.sdp.appendFmtp,t=n.split("\n"),c=[];for(let e=0;e<t.length;e++)if(0===t[e].indexOf("m=video")){let n=t[e].split(" ");for(let e=3;e<n.length;e++)c.push(n[e].replace("\r",""));break}for(let e=0;e<c.length;e++){let n=!1;for(let i=0;i<t.length;i++)0===t[i].indexOf("a=fmtp:"+c[e])&&(n=!0,t[i]+=";"+o);if(!n)for(let n=0;n<t.length;n++)0===t[n].indexOf("a=rtpmap:"+c[e])&&(t[n]+="\na=fmtp:"+c[e]+" "+o)}return t.join("\n")}function s(e,o){for(let t=0;t<o.length;t++)if(o[t]&&o[t].candidate){let c=o[t];e.addIceCandidate(new RTCIceCandidate(c)).then((function(){})).catch((function(e){console.error("peerConnection.addIceCandidate",e),n(e)}))}}e.attachMedia=function(n){e.videoElement=n},e.getUserMedia=function(o){return function(o){return o||(o={video:{deviceId:void 0},audio:{deviceId:void 0}}),console.info(t,"Requested Constraint To Input Devices",o),navigator.mediaDevices.getUserMedia(o).then((function(n){console.info(t,"Received Media Stream From Input Device",n),e.stream=n;let o=e.videoElement;return o&&(o.srcObject=n,o.onloadedmetadata=function(e){o.play()}),new Promise((function(e){e(n)}))})).catch((function(e){return console.error(t,"Can't Get Media Stream From Input Device",e),n(e),new Promise((function(n,o){o(e)}))}))}(o)},e.getDisplayMedia=function(o){return function(o){return o||(o={}),console.info(t,"Requested Constraint To Display",o),navigator.mediaDevices.getDisplayMedia(o).then((function(n){console.info(t,"Received Media Stream From Display",n),e.stream=n;let o=e.videoElement;return o&&(o.srcObject=n,o.onloadedmetadata=function(e){o.play()}),new Promise((function(e){e(n)}))})).catch((function(e){return console.error(t,"Can't Get Media Stream From Display",e),n(e),new Promise((function(n,o){o(e)}))}))}(o)},e.startStreaming=function(u,f){u+="?direction=send&transport=tcp",console.info(c,"Start Streaming"),f&&(e.connectionConfig=f),function(c){if(!c)return void n("connectionUrl is required");e.connectionUrl=c;let u=null;try{u=new WebSocket(c)}catch(e){n(e)}e.webSocket=u,u.onopen=function(){a(u,{command:"request_offer"})},u.onmessage=function(c){let u=JSON.parse(c.data);u.error&&(console.error("webSocket.onmessage",u.error),n(u.error)),"offer"===u.command&&(i=[],r=!1,function(c,u,f,p,m){window.connectionData={id:c,peerId:u};let g={};if(e.connectionConfig.iceServers)g.iceServers=e.connectionConfig.iceServers,e.connectionConfig.iceTransportPolicy&&(g.iceTransportPolicy=e.connectionConfig.iceTransportPolicy||"all");else if(m){g.iceServers=[];for(let n=0;n<m.length;n++){let o=m[n],t={};t.urls=o.urls;let c=!1,i=l(e.connectionUrl);for(let e=0;e<t.urls.length;e++)if(t.urls[e].indexOf(i)>-1){c=!0;break}if(!c&&t.urls.length>0){let e=t.urls[0],n=d(e);i&&n&&t.urls.push(e.replace(n,i))}t.username=o.user_name,t.credential=o.credential,g.iceServers.push(t)}g.iceTransportPolicy="relay"}else e.iceTransportPolicy&&(g.iceTransportPolicy=e.iceTransportPolicy);console.info(t,"Create Peer Connection With Config",g);let C=new RTCPeerConnection(g);e.peerConnection=C,e.stream.getTracks().forEach((function(n){console.info(t,"Add Track To Peer Connection",n),C.addTrack(n,e.stream)})),e.connectionConfig.maxVideoBitrate&&(f.sdp=function(e,n,o){let t=e.split("\n"),c=-1;for(let e=0;e<t.length;e++)if(0===t[e].indexOf("m=video")){c=e;break}if(-1===c)return e;for(c++;0===t[c].indexOf("i=")||0===t[c].indexOf("c=");)c++;if(0===t[c].indexOf("b"))return t[c]="b=AS:"+o,t.join("\n");let i=t.slice(0,c);return i.push("b=AS:"+o),i=i.concat(t.slice(c,t.length)),i.join("\n")}(f.sdp,0,e.connectionConfig.maxVideoBitrate)),e.connectionConfig.sdp&&e.connectionConfig.sdp.appendFmtp&&(f.sdp=o(f.sdp)),C.setRemoteDescription(new RTCSessionDescription(f)).then((function(){r=!0,i.length&&(s(e.peerConnection||C,i),i=[]),C.createAnswer().then((function(t){e.connectionConfig.sdp&&e.connectionConfig.sdp.appendFmtp&&(t.sdp=o(t.sdp)),C.setLocalDescription(t).then((function(){a(e.webSocket,{id:c,peer_id:u,command:"answer",sdp:t})})).catch((function(e){console.error("peerConnection.setLocalDescription",e),n(e)}))})).catch((function(e){console.error("peerConnection.createAnswer",e),n(e)}))})).catch((function(e){console.error("peerConnection.setRemoteDescription",e),n(e)})),p&&s(C,p),C.onicecandidate=function(n){n.candidate&&n.candidate.candidate&&(console.info(t,"Candidate Sent","\n",n.candidate.candidate,"\n",n),a(e.webSocket,{id:c,peer_id:u,command:"candidate",candidates:[n.candidate]}))},C.oniceconnectionstatechange=function(n){let o=C.iceConnectionState;e.callbacks.iceStateChange&&(console.info(t,"ICE State","["+o+"]"),e.callbacks.iceStateChange(o)),"connected"===o&&e.callbacks.connected&&(console.info(t,"Iceconnection Connected",n),e.callbacks.connected(n)),"failed"!==o&&"disconnected"!==o&&"closed"!==o||e.callbacks.connectionClosed&&(console.error(t,"Iceconnection Closed",n),e.callbacks.connectionClosed("ice",n))}}(u.id,u.peer_id,u.sdp,u.candidates,u.ice_servers)),"candidate"===u.command&&u.candidates?.length&&(e.peerConnection&&r?s(e.peerConnection,u.candidates):i.push(...u.candidates))},u.onerror=function(e){console.error("webSocket.onerror",e),n(e)},u.onclose=function(n){e.removing||e.callbacks.connectionClosed&&e.callbacks.connectionClosed("websocket",n)}}(u)},e.remove=function(){e.removing=!0,e.peerConnection&&(e.peerConnection.getSenders().forEach((function(n){e.peerConnection.removeTrack(n)})),e.peerConnection.close(),e.peerConnection=null,delete e.peerConnection),e.stream&&(e.stream.getTracks().forEach((n=>{n.stop(),e.stream.removeTrack(n)})),e.videoElement&&(e.videoElement.srcObject=null),e.stream=null,delete e.stream),e.webSocket&&(a(e.webSocket,{id:window.connectionData.id,peer_id:window.connectionData.peerId,command:"stop"}),e.webSocket.close(),e.webSocket=null,delete e.webSocket),e.status="removed",console.info(c,"Removed")}}o.create=function(e){console.info(c,"Create WebRTC");let n={removing:!1};return function(e,n){e.stream=null,e.webSocket=null,e.peerConnection=null,e.connectionConfig={},e.status="creating",e.videoElement=null,e.connectionUrl=null,n&&n.callbacks?e.callbacks=n.callbacks:e.callbacks={}}(n,e),s(n),n},o.getDevices=async function(){return await async function(){return await navigator.mediaDevices.getUserMedia({audio:{deviceId:void 0},video:{deviceId:void 0,width:1920,height:1080}})}(),function(e){let n={audioinput:[],audiooutput:[],videoinput:[],other:[]};for(let o=0;o!==e.length;++o){const t=e[o];let c={};c.deviceId=t.deviceId,"audioinput"===t.kind?(c.label=t.label||`microphone ${n.audioinput.length+1}`,n.audioinput.push(c)):"audiooutput"===t.kind?(c.label=t.label||`speaker ${n.audiooutput.length+1}`,n.audiooutput.push(c)):"videoinput"===t.kind?(c.label=t.label||`camera ${n.videoinput.length+1}`,n.videoinput.push(c)):(c.label=t.label||`other ${n.other.length+1}`,n.other.push(c))}return n}(await async function(){return await navigator.mediaDevices.enumerateDevices()}())};const u=o;return n.default})()}));
//# sourceMappingURL=QencodeWebRTC.min.js.map