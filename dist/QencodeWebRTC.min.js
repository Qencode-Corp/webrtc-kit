!function(e,n){"object"==typeof exports&&"object"==typeof module?module.exports=n():"function"==typeof define&&define.amd?define([],n):"object"==typeof exports?exports.QencodeWebRTC=n():e.QencodeWebRTC=n()}(self,(function(){return(()=>{"use strict";var e={d:(n,o)=>{for(var t in o)e.o(o,t)&&!e.o(n,t)&&Object.defineProperty(n,t,{enumerable:!0,get:o[t]})},o:(e,n)=>Object.prototype.hasOwnProperty.call(e,n)},n={};e.d(n,{default:()=>g});const o={},t="QencodeWebRTC.js :",c="QencodeWebRTC.js :";function i(e,n){e&&e.readyState===WebSocket.OPEN&&e.send(JSON.stringify(n))}function r(e){let n,o="";return(n=e.match(/^(?:wss?:\/\/)?(?:[^@\n]+@)?(?:www\.)?([^:\/\n\?\=]+)/im))&&(o=n[1]),o}function a(e){let n,o="";return(n=e.match(new RegExp("\\b(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\b","gi")))&&(o=n[0]),o}function l(){var e=window.navigator.userAgent,n=e.indexOf("OS ");return(e.indexOf("iPhone")>-1||e.indexOf("iPad")>-1)&&n>-1?window.Number(e.substr(n+3,3).replace("_",".")):0}function d(e){return e.split(/\r?\n/).map((e=>e.replace(/\r$/,"")))}function s(e){return e.join("\r\n")}function u(e,n){const o=d(e);let t=-1;for(let e=0;e<o.length-1;e++)if(o[e]=o[e].toLowerCase(),o[e].indexOf("a=rtpmap")>-1&&o[e].indexOf(n.toLowerCase())>-1){t=o[e].split(" ")[0].split(":")[1];break}return t}function f(e,n){let o=[],t=d(e);for(let e=0;e<t.length;e++)0===t[e].indexOf("m=video")?o.push(t[e].replace(" "+n,"")):t[e].indexOf(n+"")>-1||o.push(t[e]);return s(o)}function p(e,n,o){return new Promise((t=>{setTimeout((()=>{Promise.resolve(e(...n)).then(t)}),o)}))}function k(e,n){const o=d(n),t=[];for(let e=0;e<o.length;e++)if(0===o[e].indexOf("m=video")){let n=o[e].split(" ");for(let e=3;e<n.length;e++)t.push(n[e]);break}for(let n=0;n<t.length;n++){let c=!1;for(let i=0;i<o.length;i++)0===o[i].indexOf("a=fmtp:"+t[n])&&(c=!0,o[i]+=";"+e);if(!c)for(let c=0;c<o.length;c++)0===o[c].indexOf("a=rtpmap:"+t[n])&&(o[c]+="\r\na=fmtp:"+t[n]+" "+e)}return s(o)}function m(e){function n(n){if(e.error=n,"function"==typeof e.callbacks?.error)try{e.callbacks.error(n)}catch(e){console.error(t,"Error in error callback",e)}}async function o(o){if(!e.peerConnection||!o)return{replacedVideo:!1,replacedAudio:!1,oldVideoTrack:null,oldAudioTrack:null,newVideoTrack:null,newAudioTrack:null};const c=e.peerConnection,i=o.getVideoTracks()[0]||null,r=o.getAudioTracks()[0]||null,a=c.getSenders(),l=a.find((e=>e.track&&"video"===e.track.kind))||null,d=a.find((e=>e.track&&"audio"===e.track.kind))||null,s=l?.track||null,u=d?.track||null;let f=!1,p=!1;if(i&&l)try{await l.replaceTrack(i),f=!0,console.info(t,"Replaced video track in peer connection")}catch(e){console.error(t,"Error replacing video track",e),n(e)}else i&&!l&&console.warn(t,"No video sender found; cannot replaceTrack without renegotiation.");if(r&&d)try{await d.replaceTrack(r),p=!0,console.info(t,"Replaced audio track in peer connection")}catch(e){console.error(t,"Error replacing audio track",e),n(e)}else r&&!d&&console.warn(t,"No audio sender found; cannot replaceTrack without renegotiation.");return{replacedVideo:f,replacedAudio:p,oldVideoTrack:s,oldAudioTrack:u,newVideoTrack:i,newAudioTrack:r}}async function m(n){const t=e.hasActiveConnection(),c=e.stream;if(t&&c){const t=await o(n);t.replacedVideo&&c.getVideoTracks().forEach((e=>e.stop())),t.replacedAudio&&c.getAudioTracks().forEach((e=>e.stop()));const i=new MediaStream;t.newVideoTrack?i.addTrack(t.newVideoTrack):c.getVideoTracks()[0]&&i.addTrack(c.getVideoTracks()[0]),t.newAudioTrack?i.addTrack(t.newAudioTrack):c.getAudioTracks()[0]&&i.addTrack(c.getAudioTracks()[0]),e.stream=i;const r=e.videoElement;return r&&(r.srcObject=i,r.onloadedmetadata=function(e){r.play()}),i}e.stream=n;const i=e.videoElement;return i&&(i.srcObject=n,i.onloadedmetadata=function(e){i.play()}),n}function g(){i(e.webSocket,{command:"request_offer"}),e.offerRequestCount+=1}async function w(n){if(e.isManualStop)return;if(e.reconnectWebSocketPromise)return void await e.reconnectWebSocketPromise;const o=n??e.retryDelay;e.reconnectWebSocketPromise=(async()=>{try{await p(h,[],o)}finally{e.reconnectWebSocketPromise=null}})(),await e.reconnectWebSocketPromise}async function h(){if(await(navigator.onLine?Promise.resolve():new Promise((e=>{console.log("Offline. Waiting for connection..."),window.addEventListener("online",(()=>{console.log("Back online!"),e()}),{once:!0})}))),e.connectStarted=!0,!e.isManualStop)return new Promise((async function(n){let o=!0;if(e.peerConnection&&(["failed","disconnected","closed"].includes(e.peerConnection.iceConnectionState)||(o=!1)),Number.isFinite(e.retryDelay)&&Number.isFinite(e.retryMaxCount)&&e.retriesUsed<e.retryMaxCount&&o){e.isManualStop=!1,e.retriesUsed+=1,console.info(`online=${navigator.onLine}. Starting retry attempt ${e.retriesUsed}`),e.closePeerConnection(),e.closeWebSocket(),e.error=null,e.webSocketCloseEvent=null;try{await p(b,[],e.retryDelay)}catch(e){}finally{e.connectStarted=!1,n()}}n()}))}function b(){if(!e.connectionUrl)return void n("connectionUrl is required");let o=null;try{o=new WebSocket(e.connectionUrl)}catch(e){return void n(e)}e.webSocket=o,o.onopen=function(){e.retriesUsed=0,e.offerRequestCount=0,g()},o.onmessage=async function(o){let c=JSON.parse(o.data);if(c.error)return console.error("webSocket.onmessage",c.error),void await w();if("offer"===c.command)try{await async function(o,c,p,m,g){console.log({id:o,peerId:c,offer:p,candidates:m,iceServers:g}),e.connectionData={id:o,peerId:c};let h={};if(e.connectionConfig.iceServers)h.iceServers=e.connectionConfig.iceServers,e.connectionConfig.iceTransportPolicy&&(h.iceTransportPolicy=e.connectionConfig.iceTransportPolicy);else if(g){h.iceServers=[];for(let n=0;n<g.length;n++){let o=g[n],t={};t.urls=o.urls;let c=!1,i=r(e.connectionUrl);for(let e=0;e<t.urls.length;e++)if(t.urls[e].indexOf(i)>-1){c=!0;break}if(!c&&t.urls.length>0){let e=t.urls[0],n=a(e);i&&n&&t.urls.push(e.replace(n,i))}t.username=o.user_name,t.credential=o.credential,h.iceServers.push(t)}h.iceTransportPolicy="relay"}else e.iceTransportPolicy&&(h.iceTransportPolicy=e.iceTransportPolicy);console.info(t,"Create Peer Connection With Config",h);let b=new RTCPeerConnection(h);if(e.peerConnection=b,e.stream.getTracks().forEach((function(n){console.info(t,"Add Track To Peer Connection",n),b.addTrack(n,e.stream)})),l()>=15){const e=u(p.sdp,"H264");e>0&&(p.sdp=f(p.sdp,e))}e.connectionConfig.maxVideoBitrate&&(p.sdp=function(e,n,o){let t=d(e),c=-1;for(let e=0;e<t.length;e++)if(0===t[e].indexOf("m=video")){c=e;break}if(-1===c)return e;for(c++;0===t[c].indexOf("i=")||0===t[c].indexOf("c=");)c++;if(0===t[c].indexOf("b"))return t[c]="b=AS:"+o,s(t);let i=t.slice(0,c);return i.push("b=AS:"+o),i=i.concat(t.slice(c,t.length)),s(i)}(p.sdp,0,e.connectionConfig.maxVideoBitrate)),e.connectionConfig.sdp&&e.connectionConfig.sdp.appendFmtp&&(p.sdp=k(e.connectionConfig.sdp.appendFmtp,p.sdp)),b.onicecandidate=function(n){n.candidate&&n.candidate.candidate&&i(e.webSocket,{id:o,peer_id:c,command:"candidate",candidates:[n.candidate]})},b.oniceconnectionstatechange=function(n){let o=b.iceConnectionState;if(console.info(t,"ICE State","["+o+"]"),e.iceLastEvent=n,"failed"===o&&!e.isManualStop||"disconnected"===o&&!e.isManualStop?function(n=3e3){e.iceDisconnectTimeoutId||(e.iceDisconnectTimeoutId=setTimeout((function(){e.isManualStop||e.peerConnection&&["failed","disconnected"].includes(e.peerConnection.iceConnectionState)&&w(0)}),n))}():C(),e.callbacks.iceStateChange)try{e.callbacks.iceStateChange(o)}catch(e){console.error(t,"Error in iceStateChange callback",e)}if("connected"===o&&e.callbacks.connected)try{e.callbacks.connected(n)}catch(e){console.error(t,"Error in connected callback",e)}if(("failed"===o||"disconnected"===o||"closed"===o)&&e.callbacks.connectionClosed)try{e.callbacks.connectionClosed("ice",n)}catch(e){console.error(t,"Error in connectionClosed callback",e)}},b.onconnectionstatechange=async function(n){"connected"===b.connectionState&&(e.error=null,e.webSocketCloseEvent=null,e.reconnectWebSocketPromise=null)},await b.setRemoteDescription(p);const v=await b.createAnswer();if(l()>=15){const e=u(v.sdp,"H264");e>0&&(v.sdp=f(v.sdp,e))}e.connectionConfig.sdp&&e.connectionConfig.sdp.appendFmtp&&(v.sdp=k(e.connectionConfig.sdp.appendFmtp,v.sdp)),await b.setLocalDescription(v),m&&await async function(e,o){for(let t=0;t<o.length;t++)if(o[t]&&o[t].candidate){let c=o[t];try{await e.addIceCandidate(new RTCIceCandidate(c))}catch(e){console.error("peerConnection.addIceCandidate",c,e),n(e)}}}(b,m),i(e.webSocket,{id:o,peer_id:c,command:"answer",sdp:v})}(c.id,c.peer_id,c.sdp,c.candidates,c.ice_servers),e.offerRequestCount=0,e.connectStarted=!1}catch(o){e.connectStarted=!1,console.log("createPeerConnection error",o),e.offerRequestCount<3?g():await w()}},o.onerror=e=>console.log("webSocket.onerror",e),o.onclose=async function(n){if(console.log("Connection closed",n),e.webSocketCloseEvent=n,1e3!==n.code?await w():console.log("Connection closed normally."),e.connectStarted=!1,!e.isManualStop&&e.callbacks.connectionClosed)try{e.callbacks.connectionClosed("websocket",n)}catch(e){console.error(t,"Error in connectionClosed callback",e)}}}function C(){clearTimeout(e.iceDisconnectTimeoutId),e.iceDisconnectTimeoutId=null}e.attachMedia=function(n){e.videoElement=n},e.getUserMedia=function(e){return function(e){return e||(e={video:{deviceId:void 0},audio:{deviceId:void 0}}),navigator.mediaDevices.getUserMedia(e).then((async function(e){return console.info(t,"Received Media Stream From Input Device",e),await m(e)})).catch((function(e){throw console.error(t,"Can't Get Media Stream From Input Device",e),n(e),e}))}(e)},e.getDisplayMedia=function(e){return function(e){return e||(e={}),navigator.mediaDevices.getDisplayMedia(e).then((async function(e){return console.info(t,"Received Media Stream From Display",e),await m(e)})).catch((function(e){throw console.error(t,"Can't Get Media Stream From Display",e),n(e),e}))}(e)},e.switchToCamera=function(n){return async function(n){const c={width:{ideal:1920},height:{ideal:1080},aspectRatio:{ideal:1.7777777778},...n?{deviceId:{exact:n}}:{}};console.log("finalVideoConstraints",c);const i=e.stream,r=i?.getAudioTracks?.()[0]??null,a=!r,l={video:c,audio:a};let d;try{e.getUserMediaError=null,d=await navigator.mediaDevices.getUserMedia(l)}catch(o){console.warn("High-res constraints failed, trying fallback...",o);const t={video:!n||{deviceId:{exact:n}},audio:a};try{d=await navigator.mediaDevices.getUserMedia(t)}catch(n){throw e.getUserMediaError=n,n}}if(!e.hasActiveConnection()||!i){i&&i.getVideoTracks().forEach((e=>e.stop()));const n=new MediaStream,o=d.getVideoTracks()[0];if(o&&n.addTrack(o),a){const e=d.getAudioTracks()[0];e&&n.addTrack(e)}else r&&n.addTrack(r);return e.stream=n,e.videoElement&&(e.videoElement.srcObject=n),n}try{const n=await o(d);if(!n.replacedVideo)return d.getTracks().forEach((e=>e.stop())),i;i.getVideoTracks().forEach((e=>e.stop()));const t=new MediaStream;n.newVideoTrack?t.addTrack(n.newVideoTrack):i.getVideoTracks()[0]&&t.addTrack(i.getVideoTracks()[0]);const c=i.getAudioTracks()[0];c&&t.addTrack(c),e.stream=t;const r=e.videoElement;return r&&(r.srcObject=t,r.onloadedmetadata=function(e){r.play()}),t}catch(e){throw console.error(t,"Failed to switch camera",e),d&&d.getTracks().forEach((e=>e.stop())),e}}(n)},e.hasActiveConnection=function(){return e.peerConnection&&!["closed","failed"].includes(e.peerConnection.connectionState)&&!["closed","failed"].includes(e.peerConnection.iceConnectionState)},e.startStreaming=function(n,o){e.connectionUrl=n+"?direction=send&transport=tcp",console.info(c,"Start Streaming"),o&&(e.connectionConfig=o),e.retriesUsed=0,e.isManualStop=!1,b()},e.closePeerConnection=function(){C(),e.peerConnection&&(e.peerConnection.getSenders().forEach((function(n){e.peerConnection.removeTrack(n)})),e.peerConnection.close(),e.peerConnection=null)},e.closeWebSocket=function(){e.webSocket&&e.webSocket.readyState!==WebSocket.CLOSED&&(e.webSocket.onclose=null,e.webSocket.onerror=null,e.webSocket.onmessage=null,e.connectionData&&i(e.webSocket,{id:e.connectionData.id,peer_id:e.connectionData.peerId,command:"stop"}),e.webSocket.close(),e.webSocket=null)},e.closeVideoAudioStreams=function(){e.stream&&(e.stream.getTracks().forEach((n=>{n.stop(),e.stream.removeTrack(n)})),e.videoElement&&(e.videoElement.srcObject=null),e.stream=null)},e.remove=function(){e.isManualStop=!0,e.closePeerConnection(),e.closeVideoAudioStreams(),e.closeWebSocket(),console.info(c,"Removed")}}o.create=function(e={}){console.info("QencodeWebRTC ","2025-12-22");const n=function(e){let n={retryMaxCount:2,retryDelay:2e3,connectionConfig:{},connectionUrl:null,connectStarted:!1,error:null,offerRequestCount:0,peerConnection:null,retriesUsed:0,stream:null,videoElement:null,webSocket:null,webSocketCloseEvent:null,isManualStop:!1};return e&&e.callbacks?n.callbacks=e.callbacks:n.callbacks={},n}(e);return m(n),n},o.getDevices=async function(){return await async function(){const e=await navigator.mediaDevices.getUserMedia({audio:{deviceId:void 0},video:{deviceId:void 0,width:{ideal:1920},height:{ideal:1080}}});return e.getTracks().forEach((e=>e.stop())),e}(),function(e){let n={audioinput:[],audiooutput:[],videoinput:[],other:[]};for(let o=0;o!==e.length;++o){const t=e[o];let c={};c.deviceId=t.deviceId,"audioinput"===t.kind?(c.label=t.label||`microphone ${n.audioinput.length+1}`,n.audioinput.push(c)):"audiooutput"===t.kind?(c.label=t.label||`speaker ${n.audiooutput.length+1}`,n.audiooutput.push(c)):"videoinput"===t.kind?(c.label=t.label||`camera ${n.videoinput.length+1}`,n.videoinput.push(c)):(c.label=t.label||`other ${n.other.length+1}`,n.other.push(c))}return n}(await async function(){return await navigator.mediaDevices.enumerateDevices()}())};const g=o;return n.default})()}));
//# sourceMappingURL=QencodeWebRTC.min.js.map