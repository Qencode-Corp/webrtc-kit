!function(e,n){"object"==typeof exports&&"object"==typeof module?module.exports=n():"function"==typeof define&&define.amd?define([],n):"object"==typeof exports?exports.QencodeWebRTC=n():e.QencodeWebRTC=n()}(self,(function(){return(()=>{"use strict";var e={d:(n,t)=>{for(var o in t)e.o(t,o)&&!e.o(n,o)&&Object.defineProperty(n,o,{enumerable:!0,get:t[o]})},o:(e,n)=>Object.prototype.hasOwnProperty.call(e,n)},n={};e.d(n,{default:()=>s});const t={},o="QencodeWebRTC.js :",i="QencodeWebRTC.js :";function c(e,n){e&&e.send(JSON.stringify(n))}function r(e){let n,t="";return(n=e.match(/^(?:wss?:\/\/)?(?:[^@\n]+@)?(?:www\.)?([^:\/\n\?\=]+)/im))&&(t=n[1]),t}function a(e){let n,t="";return(n=e.match(new RegExp("\\b(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\b","gi")))&&(t=n[0]),t}function d(e){function n(n){e.callbacks.error&&e.callbacks.error(n)}function t(n){const t=e.connectionConfig.sdp.appendFmtp,o=n.split("\n"),i=[];for(let e=0;e<o.length;e++)if(0===o[e].indexOf("m=video")){let n=o[e].split(" ");for(let e=3;e<n.length;e++)i.push(n[e].replace("\r",""));break}for(let e=0;e<i.length;e++){let n=!1;for(let c=0;c<o.length;c++)0===o[c].indexOf("a=fmtp:"+i[e])&&(n=!0,o[c]+=";"+t);if(!n)for(let n=0;n<o.length;n++)0===o[n].indexOf("a=rtpmap:"+i[e])&&(o[n]+="\na=fmtp:"+i[e]+" "+t)}return o.join("\n")}function d(e,t){for(let o=0;o<t.length;o++)if(t[o]&&t[o].candidate){let i=t[o];e.addIceCandidate(new RTCIceCandidate(i)).then((function(){})).catch((function(e){console.error("peerConnection.addIceCandidate",e),n(e)}))}}e.pendingRemoteCandidates=[],e.remoteDescriptionSet=!1,e.attachMedia=function(n){e.videoElement=n},e.getUserMedia=function(t){return function(t){return t||(t={video:{deviceId:void 0},audio:{deviceId:void 0}}),console.info(o,"Requested Constraint To Input Devices",t),navigator.mediaDevices.getUserMedia(t).then((function(n){console.info(o,"Received Media Stream From Input Device",n),e.stream=n;let t=e.videoElement;return t&&(t.srcObject=n,t.onloadedmetadata=function(e){t.play()}),new Promise((function(e){e(n)}))})).catch((function(e){return console.error(o,"Can't Get Media Stream From Input Device",e),n(e),new Promise((function(n,t){t(e)}))}))}(t)},e.getDisplayMedia=function(t){return function(t){return t||(t={}),console.info(o,"Requested Constraint To Display",t),navigator.mediaDevices.getDisplayMedia(t).then((function(n){console.info(o,"Received Media Stream From Display",n),e.stream=n;let t=e.videoElement;return t&&(t.srcObject=n,t.onloadedmetadata=function(e){t.play()}),new Promise((function(e){e(n)}))})).catch((function(e){return console.error(o,"Can't Get Media Stream From Display",e),n(e),new Promise((function(n,t){t(e)}))}))}(t)},e.startStreaming=function(s,l){s+="?direction=send&transport=tcp",console.info(i,"Start Streaming"),l&&(e.connectionConfig=l),function(i){if(!i)return void n("connectionUrl is required");e.connectionUrl=i;let s=null;try{s=new WebSocket(i)}catch(e){n(e)}e.webSocket=s,s.onopen=function(){c(s,{command:"request_offer"})},s.onmessage=function(i){let s=JSON.parse(i.data);s.error&&(console.error("webSocket.onmessage",s.error),n(s.error)),"offer"===s.command&&(e.pendingRemoteCandidates=[],e.remoteDescriptionSet=!1,function(i,s,l,u,f){window.connectionData={id:i,peerId:s};let p={};if(e.connectionConfig.iceServers)p.iceServers=e.connectionConfig.iceServers,e.connectionConfig.iceTransportPolicy&&(p.iceTransportPolicy=e.connectionConfig.iceTransportPolicy||"all");else if(f){p.iceServers=[];for(let n=0;n<f.length;n++){let t=f[n],o={};o.urls=t.urls;let i=!1,c=r(e.connectionUrl);for(let e=0;e<o.urls.length;e++)if(o.urls[e].indexOf(c)>-1){i=!0;break}if(!i&&o.urls.length>0){let e=o.urls[0],n=a(e);c&&n&&o.urls.push(e.replace(n,c))}o.username=t.user_name,o.credential=t.credential,p.iceServers.push(o)}p.iceTransportPolicy="relay"}else e.iceTransportPolicy&&(p.iceTransportPolicy=e.iceTransportPolicy);console.info(o,"Create Peer Connection With Config",p);let m=new RTCPeerConnection(p);e.peerConnection=m;let g=!1;m.oniceconnectionstatechange=()=>{const n=m.iceConnectionState;if(e.callbacks?.iceStateChange?.(n),("failed"===n||"disconnected"===n)&&!g){g=!0;try{"function"==typeof m.restartIce&&(console.log("[ICE] restartingâ€¦"),m.restartIce())}catch(e){console.warn("restartIce failed:",e)}}"connected"===n&&(g=!1)},e.stream.getTracks().forEach((function(n){console.info(o,"Add Track To Peer Connection",n),m.addTrack(n,e.stream)})),e.connectionConfig.maxVideoBitrate&&(l.sdp=function(e,n,t){let o=e.split("\n"),i=-1;for(let e=0;e<o.length;e++)if(0===o[e].indexOf("m=video")){i=e;break}if(-1===i)return e;for(i++;0===o[i].indexOf("i=")||0===o[i].indexOf("c=");)i++;if(0===o[i].indexOf("b"))return o[i]="b=AS:"+t,o.join("\n");let c=o.slice(0,i);return c.push("b=AS:"+t),c=c.concat(o.slice(i,o.length)),c.join("\n")}(l.sdp,0,e.connectionConfig.maxVideoBitrate)),e.connectionConfig.sdp&&e.connectionConfig.sdp.appendFmtp&&(l.sdp=t(l.sdp)),m.setRemoteDescription(new RTCSessionDescription(l)).then((function(){e.remoteDescriptionSet=!0,e.pendingRemoteCandidates.length&&(d(e.peerConnection,e.pendingRemoteCandidates),e.pendingRemoteCandidates=[]),m.createAnswer().then((function(o){e.connectionConfig.sdp&&e.connectionConfig.sdp.appendFmtp&&(o.sdp=t(o.sdp)),m.setLocalDescription(o).then((function(){c(e.webSocket,{id:i,peer_id:s,command:"answer",sdp:o})})).catch((function(e){console.error("peerConnection.setLocalDescription",e),n(e)}))})).catch((function(e){console.error("peerConnection.createAnswer",e),n(e)}))})).catch((function(e){console.error("peerConnection.setRemoteDescription",e),n(e)})),u&&d(m,u),m.onicecandidate=function(n){n.candidate&&n.candidate.candidate&&(console.info(o,"Candidate Sent","\n",n.candidate.candidate,"\n",n),c(e.webSocket,{id:i,peer_id:s,command:"candidate",candidates:[n.candidate]}))},m.oniceconnectionstatechange=function(n){let t=m.iceConnectionState;e.callbacks.iceStateChange&&(console.info(o,"ICE State","["+t+"]"),e.callbacks.iceStateChange(t)),"connected"===t&&e.callbacks.connected&&(console.info(o,"Iceconnection Connected",n),e.callbacks.connected(n)),"failed"!==t&&"disconnected"!==t&&"closed"!==t||e.callbacks.connectionClosed&&(console.error(o,"Iceconnection Closed",n),e.callbacks.connectionClosed("ice",n))}}(s.id,s.peer_id,s.sdp,s.candidates,s.ice_servers)),"candidate"===s.command&&s.candidates?.length&&(e.peerConnection&&e.remoteDescriptionSet?d(e.peerConnection,s.candidates):e.pendingRemoteCandidates.push(...s.candidates))},s.onerror=function(e){console.error("webSocket.onerror",e),n(e)},s.onclose=function(n){e.removing||e.callbacks.connectionClosed&&e.callbacks.connectionClosed("websocket",n)}}(s)},e.remove=function(){e.removing=!0,e.peerConnection&&(e.peerConnection.getSenders().forEach((function(n){e.peerConnection.removeTrack(n)})),e.peerConnection.close(),e.peerConnection=null,delete e.peerConnection),e.stream&&(e.stream.getTracks().forEach((n=>{n.stop(),e.stream.removeTrack(n)})),e.videoElement&&(e.videoElement.srcObject=null),e.stream=null,delete e.stream),e.webSocket&&(c(e.webSocket,{id:window.connectionData.id,peer_id:window.connectionData.peerId,command:"stop"}),e.webSocket.close(),e.webSocket=null,delete e.webSocket),e.status="removed",console.info(i,"Removed")}}t.create=function(e){console.info(i,"Create WebRTC");let n={removing:!1};return function(e,n){e.stream=null,e.webSocket=null,e.peerConnection=null,e.connectionConfig={},e.status="creating",e.videoElement=null,e.connectionUrl=null,n&&n.callbacks?e.callbacks=n.callbacks:e.callbacks={}}(n,e),d(n),n},t.getDevices=async function(){return await async function(){return await navigator.mediaDevices.getUserMedia({audio:{deviceId:void 0},video:{deviceId:void 0,width:1920,height:1080}})}(),function(e){let n={audioinput:[],audiooutput:[],videoinput:[],other:[]};for(let t=0;t!==e.length;++t){const o=e[t];let i={};i.deviceId=o.deviceId,"audioinput"===o.kind?(i.label=o.label||`microphone ${n.audioinput.length+1}`,n.audioinput.push(i)):"audiooutput"===o.kind?(i.label=o.label||`speaker ${n.audiooutput.length+1}`,n.audiooutput.push(i)):"videoinput"===o.kind?(i.label=o.label||`camera ${n.videoinput.length+1}`,n.videoinput.push(i)):(i.label=o.label||`other ${n.other.length+1}`,n.other.push(i))}return n}(await async function(){return await navigator.mediaDevices.enumerateDevices()}())};const s=t;return n.default})()}));
//# sourceMappingURL=QencodeWebRTC.min.js.map