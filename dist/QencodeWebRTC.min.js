!function(e,n){"object"==typeof exports&&"object"==typeof module?module.exports=n():"function"==typeof define&&define.amd?define([],n):"object"==typeof exports?exports.QencodeWebRTC=n():e.QencodeWebRTC=n()}(self,(function(){return(()=>{"use strict";var n={d:(e,t)=>{for(var o in t)n.o(t,o)&&!n.o(e,o)&&Object.defineProperty(e,o,{enumerable:!0,get:t[o]})},o:(e,n)=>Object.prototype.hasOwnProperty.call(e,n)},t={};n.d(t,{default:()=>g});const o={},i="QencodeWebRTC.js :",r="QencodeWebRTC.js :";function c(e,n){e&&e.send(JSON.stringify(n))}function a(e){let n,t="";return(n=e.match(/^(?:wss?:\/\/)?(?:[^@\n]+@)?(?:www\.)?([^:\/\n\?\=]+)/im))&&(t=n[1]),t}function s(e){let n,t="";return(n=e.match(new RegExp("\\b(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\b","gi")))&&(t=n[0]),t}function d(){var e=window.navigator.userAgent,n=e.indexOf("OS ");return(e.indexOf("iPhone")>-1||e.indexOf("iPad")>-1)&&n>-1?window.Number(e.substr(n+3,3).replace("_",".")):0}function l(e){return e.split(/\r?\n/).map((e=>e.replace(/\r$/,"")))}function u(e){return e.join("\r\n")}function f(e,n){const t=l(e);let o=-1;for(let e=0;e<t.length-1;e++)if(t[e]=t[e].toLowerCase(),t[e].indexOf("a=rtpmap")>-1&&t[e].indexOf(n.toLowerCase())>-1){o=t[e].split(" ")[0].split(":")[1];break}return o}function p(e,n){let t=[],o=l(e);for(let e=0;e<o.length;e++)0===o[e].indexOf("m=video")?t.push(o[e].replace(" "+n,"")):o[e].indexOf(n+"")>-1||t.push(o[e]);return u(t)}function m(e,n,t){return new Promise((o=>{setTimeout((()=>{Promise.resolve(e(...n)).then(o)}),t)}))}o.create=function(){console.info(r,"Create WebRTC");let n={retryMaxCount:2,retryDelay:2e3,removing:!1};return function(e){e.videoElement=null,e.connectionUrl=null,e.connectionConfig={},e.stream=null,e.webSocket=null,e.webSocketCloseEvent=null,e.retryingWebSocket=!1,e.retriesUsed=0,e.peerConnection=null,e.createPeerConnectionCount=0,e.status="creating",e.error=null,e.offerRequestCount=0}(n),function(n){function t(e){n.error=e}function o(r){if(!r)return void t("connectionUrl is required");n.connectionUrl=r;let C=null;try{C=new WebSocket(r)}catch(e){return void t(e)}function v(){c(n.webSocket,{command:"request_offer"}),n.offerRequestCount+=1}async function w(e){t(e),!n.removing&&!n.retryingWebSocket&&Number.isFinite(n.retryDelay)&&Number.isFinite(n.retryMaxCount)&&n.retriesUsed<n.retryMaxCount&&(n.retriesUsed+=1,n.retryingWebSocket=!0,console.info(`Starting retry attempt ${n.retriesUsed}`),n.webSocket&&n.webSocket.readyState!==WebSocket.CLOSED&&(n.webSocket.onerror=null,n.webSocket.onclose=null,n.webSocket.onmessage=null,n.webSocket.onopen=null,n.webSocket.close()),n.error=null,n.webSocketCloseEvent=null,n.peerConnection=null,await m(o,[r],n.retryDelay),n.retryingWebSocket=!1)}n.webSocket=C,C.onopen=function(){v()},C.onmessage=async function(e){let o=JSON.parse(e.data);if(o.error&&(console.error("webSocket.onmessage",o.error),t(o.error)),"offer"===o.command)try{await async function(e,o,r,m,C){window.connectionData={id:e,peerId:o};let v={};if(n.connectionConfig.iceServers)v.iceServers=n.connectionConfig.iceServers,n.connectionConfig.iceTransportPolicy&&(v.iceTransportPolicy=n.connectionConfig.iceTransportPolicy);else if(C){v.iceServers=[];for(let e=0;e<C.length;e++){let t=C[e],o={};o.urls=t.urls;let i=!1,r=a(n.connectionUrl);for(let e=0;e<o.urls.length;e++)if(o.urls[e].indexOf(r)>-1){i=!0;break}if(!i&&o.urls.length>0){let e=o.urls[0],n=s(e);r&&n&&o.urls.push(e.replace(n,r))}o.username=t.user_name,o.credential=t.credential,v.iceServers.push(o)}v.iceTransportPolicy="relay"}else n.iceTransportPolicy&&(v.iceTransportPolicy=n.iceTransportPolicy);console.info(i,"Create Peer Connection With Config",v);let w=new RTCPeerConnection(v);if(n.peerConnection=w,n.stream.getTracks().forEach((function(e){console.info(i,"Add Track To Peer Connection",e),w.addTrack(e,n.stream)})),d()>=15){const e=f(r.sdp,"H264");e>0&&(r.sdp=p(r.sdp,e))}n.connectionConfig.maxVideoBitrate&&(r.sdp=function(e,n,t){let o=l(e),i=-1;for(let e=0;e<o.length;e++)if(0===o[e].indexOf("m=video")){i=e;break}if(-1===i)return e;for(i++;0===o[i].indexOf("i=")||0===o[i].indexOf("c=");)i++;if(0===o[i].indexOf("b"))return o[i]="b=AS:"+t,u(o);let r=o.slice(0,i);return r.push("b=AS:"+t),r=r.concat(o.slice(i,o.length)),u(r)}(r.sdp,0,n.connectionConfig.maxVideoBitrate)),n.connectionConfig.sdp&&n.connectionConfig.sdp.appendFmtp&&(r.sdp=g(r.sdp)),w.onicecandidate=function(t){t.candidate&&t.candidate.candidate&&(console.info(i,"Candidate Sent","\n",t.candidate.candidate,"\n",t),c(n.webSocket,{id:e,peer_id:o,command:"candidate",candidates:[t.candidate]}))},w.oniceconnectionstatechange=function(e){let t=w.iceConnectionState;console.info(i,"ICE State","["+t+"]"),n.iceLastEvent=e,"connected"===t&&console.info(i,"Iceconnection Connected",e),"failed"!==t&&"disconnected"!==t&&"closed"!==t||console.error(i,"Iceconnection Closed",e)},await w.setRemoteDescription(r);const b=await w.createAnswer();if(d()>=15){const e=f(b.sdp,"H264");e>0&&(b.sdp=p(b.sdp,e))}n.connectionConfig.sdp&&n.connectionConfig.sdp.appendFmtp&&(b.sdp=g(b.sdp)),await w.setLocalDescription(b),m&&await async function(e,n){for(let o=0;o<n.length;o++)if(n[o]&&n[o].candidate){let i=n[o];try{await e.addIceCandidate(new RTCIceCandidate(i))}catch(e){console.error("peerConnection.addIceCandidate",i,e),t(e)}}}(w,m),c(n.webSocket,{id:e,peer_id:o,command:"answer",sdp:b})}(o.id,o.peer_id,o.sdp,o.candidates,o.ice_servers),n.createPeerConnectionCount+=1,n.offerRequestCount=0}catch(e){console.log("createPeerConnection error",e),n.offerRequestCount<3?v():await m((async()=>{0===n.createPeerConnectionCount&&await w(e)}),[],2e3)}},C.onerror=e=>console.error("webSocket.onerror",e),C.onclose=async function(t){console.log("Connection closed",t),1e3!==t.code?await m((async()=>await w(e)),[],2e3):console.log("Connection closed normally."),n.removing||(n.webSocketCloseEvent=t)}}function g(e){const t=n.connectionConfig.sdp.appendFmtp,o=l(e),i=[];for(let e=0;e<o.length;e++)if(0===o[e].indexOf("m=video")){let n=o[e].split(" ");for(let e=3;e<n.length;e++)i.push(n[e]);break}for(let e=0;e<i.length;e++){let n=!1;for(let r=0;r<o.length;r++)0===o[r].indexOf("a=fmtp:"+i[e])&&(n=!0,o[r]+=";"+t);if(!n)for(let n=0;n<o.length;n++)0===o[n].indexOf("a=rtpmap:"+i[e])&&(o[n]+="\r\na=fmtp:"+i[e]+" "+t)}return u(o)}n.attachMedia=function(e){n.videoElement=e},n.getUserMedia=function(e){return function(e){return e||(e={video:{deviceId:void 0},audio:{deviceId:void 0}}),console.info(i,"Requested Constraint To Input Devices",e),navigator.mediaDevices.getUserMedia(e).then((function(e){console.info(i,"Received Media Stream From Input Device",e),n.stream=e;let t=n.videoElement;return t&&(t.srcObject=e,t.onloadedmetadata=function(e){t.play()}),new Promise((function(n){n(e)}))})).catch((function(e){return console.error(i,"Can't Get Media Stream From Input Device",e),t(e),new Promise((function(n,t){t(e)}))}))}(e)},n.getDisplayMedia=function(e){return function(e){return e||(e={}),console.info(i,"Requested Constraint To Display",e),navigator.mediaDevices.getDisplayMedia(e).then((function(e){console.info(i,"Received Media Stream From Display",e),n.stream=e;let t=n.videoElement;return t&&(t.srcObject=e,t.onloadedmetadata=function(e){t.play()}),new Promise((function(n){n(e)}))})).catch((function(e){return console.error(i,"Can't Get Media Stream From Display",e),t(e),new Promise((function(n,t){t(e)}))}))}(e)},n.startStreaming=function(e,t){e+="?direction=send&transport=tcp",console.info(r,"Start Streaming"),t&&(n.connectionConfig=t),n.retriesUsed=0,o(e)},n.remove=function(){n.removing=!0,n.peerConnection&&(n.peerConnection.getSenders().forEach((function(e){n.peerConnection.removeTrack(e)})),n.peerConnection.close(),n.peerConnection=null,delete n.peerConnection),n.stream&&(n.stream.getTracks().forEach((e=>{e.stop(),n.stream.removeTrack(e)})),n.videoElement&&(n.videoElement.srcObject=null),n.stream=null,delete n.stream),n.webSocket&&(c(n.webSocket,{id:window.connectionData.id,peer_id:window.connectionData.peerId,command:"stop"}),n.webSocket.close(),n.webSocket=null,delete n.webSocket),n.status="removed",console.info(r,"Removed")}}(n),n},o.getDevices=async function(){return await async function(){return await navigator.mediaDevices.getUserMedia({audio:{deviceId:void 0},video:{deviceId:void 0,width:1920,height:1080}})}(),function(e){let n={audioinput:[],audiooutput:[],videoinput:[],other:[]};for(let t=0;t!==e.length;++t){const o=e[t];let i={};i.deviceId=o.deviceId,"audioinput"===o.kind?(i.label=o.label||`microphone ${n.audioinput.length+1}`,n.audioinput.push(i)):"audiooutput"===o.kind?(i.label=o.label||`speaker ${n.audiooutput.length+1}`,n.audiooutput.push(i)):"videoinput"===o.kind?(i.label=o.label||`camera ${n.videoinput.length+1}`,n.videoinput.push(i)):(i.label=o.label||`other ${n.other.length+1}`,n.other.push(i))}return n}(await async function(){return await navigator.mediaDevices.enumerateDevices()}())};const g=o;return t.default})()}));
//# sourceMappingURL=QencodeWebRTC.min.js.map