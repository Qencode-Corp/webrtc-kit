!function(e,n){"object"==typeof exports&&"object"==typeof module?module.exports=n():"function"==typeof define&&define.amd?define([],n):"object"==typeof exports?exports.QencodeWebRTC=n():e.QencodeWebRTC=n()}(self,(function(){return(()=>{"use strict";var e={d:(n,t)=>{for(var o in t)e.o(t,o)&&!e.o(n,o)&&Object.defineProperty(n,o,{enumerable:!0,get:t[o]})},o:(e,n)=>Object.prototype.hasOwnProperty.call(e,n)},n={};e.d(n,{default:()=>w});const t={},o="QencodeWebRTC.js :",i="QencodeWebRTC.js :";function c(e,n){e&&e.readyState===WebSocket.OPEN&&e.send(JSON.stringify(n))}function r(e){let n,t="";return(n=e.match(/^(?:wss?:\/\/)?(?:[^@\n]+@)?(?:www\.)?([^:\/\n\?\=]+)/im))&&(t=n[1]),t}function a(e){let n,t="";return(n=e.match(new RegExp("\\b(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\b","gi")))&&(t=n[0]),t}function l(){var e=window.navigator.userAgent,n=e.indexOf("OS ");return(e.indexOf("iPhone")>-1||e.indexOf("iPad")>-1)&&n>-1?window.Number(e.substr(n+3,3).replace("_",".")):0}function s(e){return e.split(/\r?\n/).map((e=>e.replace(/\r$/,"")))}function d(e){return e.join("\r\n")}function u(e,n){const t=s(e);let o=-1;for(let e=0;e<t.length-1;e++)if(t[e]=t[e].toLowerCase(),t[e].indexOf("a=rtpmap")>-1&&t[e].indexOf(n.toLowerCase())>-1){o=t[e].split(" ")[0].split(":")[1];break}return o}function f(e,n){let t=[],o=s(e);for(let e=0;e<o.length;e++)0===o[e].indexOf("m=video")?t.push(o[e].replace(" "+n,"")):o[e].indexOf(n+"")>-1||t.push(o[e]);return d(t)}function p(e,n,t){return new Promise((o=>{setTimeout((()=>{Promise.resolve(e(...n)).then(o)}),t)}))}function m(e,n){const t=s(n),o=[];for(let e=0;e<t.length;e++)if(0===t[e].indexOf("m=video")){let n=t[e].split(" ");for(let e=3;e<n.length;e++)o.push(n[e]);break}for(let n=0;n<o.length;n++){let i=!1;for(let c=0;c<t.length;c++)0===t[c].indexOf("a=fmtp:"+o[n])&&(i=!0,t[c]+=";"+e);if(!i)for(let i=0;i<t.length;i++)0===t[i].indexOf("a=rtpmap:"+o[n])&&(t[i]+="\r\na=fmtp:"+o[n]+" "+e)}return d(t)}function S(e){function n(n){e.error=n}function t(){c(e.webSocket,{command:"request_offer"}),e.offerRequestCount+=1}async function S(n){e.isManualStop||e.reconnectWebSocketPromise&&(await e.reconnectWebSocketPromise,e.isManualStop)||(e.reconnectWebSocketPromise=p(w,[],n??e.retryDelay),await e.reconnectWebSocketPromise,e.reconnectWebSocketPromise=null)}async function w(){if(await(navigator.onLine?Promise.resolve():new Promise((e=>{console.log("Offline. Waiting for connection..."),window.addEventListener("online",(()=>{console.log("Back online!"),e()}),{once:!0})}))),e.connectStarted=!0,!e.isManualStop)return new Promise((async function(n){let t=!0;if(e.peerConnection&&(["failed","disconnected","closed"].includes(e.peerConnection.iceConnectionState)||(t=!1)),Number.isFinite(e.retryDelay)&&Number.isFinite(e.retryMaxCount)&&e.retriesUsed<e.retryMaxCount&&t){e.isManualStop=!1,e.closePeerConnection(),e.retriesUsed+=1,console.info(`online=${navigator.onLine}. Starting retry attempt ${e.retriesUsed}`),e.webSocket&&e.webSocket.readyState!==WebSocket.CLOSED&&(e.webSocket.onerror=null,e.webSocket.onclose=null,e.webSocket.onmessage=null,e.webSocket.onopen=null,e.webSocket.close()),e.error=null,e.webSocketCloseEvent=null,e.peerConnection=null;try{await p(g,[],e.retryDelay)}catch(e){}finally{e.connectStarted=!1,n()}}n()}))}function g(){if(!e.connectionUrl)return void n("connectionUrl is required");let i=null;try{i=new WebSocket(e.connectionUrl)}catch(e){return void n(e)}e.webSocket=i,i.onopen=function(){e.retriesUsed=0,e.offerRequestCount=0,t()},i.onmessage=async function(i){let p=JSON.parse(i.data);if(p.error)return console.error("webSocket.onmessage",p.error),void await S();if("offer"===p.command)try{await async function(t,i,p,w,g){window.connectionData={id:t,peerId:i};let b={};if(e.connectionConfig.iceServers)b.iceServers=e.connectionConfig.iceServers,e.connectionConfig.iceTransportPolicy&&(b.iceTransportPolicy=e.connectionConfig.iceTransportPolicy);else if(g){b.iceServers=[];for(let n=0;n<g.length;n++){let t=g[n],o={};o.urls=t.urls;let i=!1,c=r(e.connectionUrl);for(let e=0;e<o.urls.length;e++)if(o.urls[e].indexOf(c)>-1){i=!0;break}if(!i&&o.urls.length>0){let e=o.urls[0],n=a(e);c&&n&&o.urls.push(e.replace(n,c))}o.username=t.user_name,o.credential=t.credential,b.iceServers.push(o)}b.iceTransportPolicy="relay"}else e.iceTransportPolicy&&(b.iceTransportPolicy=e.iceTransportPolicy);console.info(o,"Create Peer Connection With Config",b);let C=new RTCPeerConnection(b);if(e.peerConnection=C,e.stream.getTracks().forEach((function(n){console.info(o,"Add Track To Peer Connection",n),C.addTrack(n,e.stream)})),l()>=15){const e=u(p.sdp,"H264");e>0&&(p.sdp=f(p.sdp,e))}e.connectionConfig.maxVideoBitrate&&(p.sdp=function(e,n,t){let o=s(e),i=-1;for(let e=0;e<o.length;e++)if(0===o[e].indexOf("m=video")){i=e;break}if(-1===i)return e;for(i++;0===o[i].indexOf("i=")||0===o[i].indexOf("c=");)i++;if(0===o[i].indexOf("b"))return o[i]="b=AS:"+t,d(o);let c=o.slice(0,i);return c.push("b=AS:"+t),c=c.concat(o.slice(i,o.length)),d(c)}(p.sdp,0,e.connectionConfig.maxVideoBitrate)),e.connectionConfig.sdp&&e.connectionConfig.sdp.appendFmtp&&(p.sdp=m(e.connectionConfig.sdp.appendFmtp,p.sdp)),C.onicecandidate=function(n){n.candidate&&n.candidate.candidate&&c(e.webSocket,{id:t,peer_id:i,command:"candidate",candidates:[n.candidate]})},C.oniceconnectionstatechange=function(n){let t=C.iceConnectionState;console.info(o,"ICE State","["+t+"]"),e.iceLastEvent=n,"failed"===t&&!e.isManualStop||"disconnected"===t&&!e.isManualStop?function(n=3e3){e.iceDisconnectTimeoutId||(e.iceDisconnectTimeoutId=setTimeout((function(){e.isManualStop||e.peerConnection&&["failed","disconnected"].includes(e.peerConnection.iceConnectionState)&&S(0)}),n))}():clearTimeout(e.iceDisconnectTimeoutId)},C.onconnectionstatechange=async function(n){"connected"===C.connectionState&&(e.error=null,e.webSocketCloseEvent=null,e.reconnectWebSocketPromise=null)},await C.setRemoteDescription(p);const v=await C.createAnswer();if(l()>=15){const e=u(v.sdp,"H264");e>0&&(v.sdp=f(v.sdp,e))}e.connectionConfig.sdp&&e.connectionConfig.sdp.appendFmtp&&(v.sdp=m(e.connectionConfig.sdp.appendFmtp,v.sdp)),await C.setLocalDescription(v),w&&await async function(e,t){for(let o=0;o<t.length;o++)if(t[o]&&t[o].candidate){let i=t[o];try{await e.addIceCandidate(new RTCIceCandidate(i))}catch(e){console.error("peerConnection.addIceCandidate",i,e),n(e)}}}(C,w),c(e.webSocket,{id:t,peer_id:i,command:"answer",sdp:v})}(p.id,p.peer_id,p.sdp,p.candidates,p.ice_servers),e.offerRequestCount=0,e.connectStarted=!1}catch(i){e.connectStarted=!1,console.log("createPeerConnection error",i),e.offerRequestCount<3?t():await S()}},i.onerror=e=>console.log("webSocket.onerror",e),i.onclose=async function(n){console.log("Connection closed",n),e.webSocketCloseEvent=n,1e3!==n.code?await S():console.log("Connection closed normally."),e.connectStarted=!1}}e.attachMedia=function(n){e.videoElement=n},e.getUserMedia=function(t){return function(t){return t||(t={video:{deviceId:void 0},audio:{deviceId:void 0}}),navigator.mediaDevices.getUserMedia(t).then((function(n){console.info(o,"Received Media Stream From Input Device",n),e.stream=n;let t=e.videoElement;return t&&(t.srcObject=n,t.onloadedmetadata=function(e){t.play()}),new Promise((function(e){e(n)}))})).catch((function(e){return console.error(o,"Can't Get Media Stream From Input Device",e),n(e),new Promise((function(n,t){t(e)}))}))}(t)},e.getDisplayMedia=function(t){return function(t){return t||(t={}),navigator.mediaDevices.getDisplayMedia(t).then((function(n){console.info(o,"Received Media Stream From Display",n),e.stream=n;let t=e.videoElement;return t&&(t.srcObject=n,t.onloadedmetadata=function(e){t.play()}),new Promise((function(e){e(n)}))})).catch((function(e){return console.error(o,"Can't Get Media Stream From Display",e),n(e),new Promise((function(n,t){t(e)}))}))}(t)},e.startStreaming=function(n,t){e.connectionUrl=n+"?direction=send&transport=tcp",console.info(i,"Start Streaming"),t&&(e.connectionConfig=t),e.retriesUsed=0,e.isManualStop=!1,g()},e.closePeerConnection=function(){e.peerConnection&&(e.peerConnection.getSenders().forEach((function(n){e.peerConnection.removeTrack(n)})),e.peerConnection.close(),e.peerConnection=null)},e.closeWebSocket=function(){e.webSocket&&(e.webSocket.onclose=null,e.webSocket.onerror=null,e.webSocket.onmessage=null,c(e.webSocket,{id:window.connectionData.id,peer_id:window.connectionData.peerId,command:"stop"}),e.webSocket.close(),e.webSocket=null)},e.remove=function(){e.isManualStop=!0,clearTimeout(e.iceDisconnectTimeoutId),e.closePeerConnection(),e.stream&&(e.stream.getTracks().forEach((n=>{n.stop(),e.stream.removeTrack(n)})),e.videoElement&&(e.videoElement.srcObject=null),e.stream=null),e.closeWebSocket(),console.info(i,"Removed")}}t.create=function(){let e={retryMaxCount:2,retryDelay:2e3};return function(e){e.connectionConfig={},e.connectionUrl=null,e.connectStarted=!1,e.error=null,e.offerRequestCount=0,e.peerConnection=null,e.retriesUsed=0,e.stream=null,e.videoElement=null,e.webSocket=null,e.webSocketCloseEvent=null,e.isManualStop=!1}(e),S(e),e},t.getDevices=async function(){return await async function(){return await navigator.mediaDevices.getUserMedia({audio:{deviceId:void 0},video:{deviceId:void 0,width:1920,height:1080}})}(),function(e){let n={audioinput:[],audiooutput:[],videoinput:[],other:[]};for(let t=0;t!==e.length;++t){const o=e[t];let i={};i.deviceId=o.deviceId,"audioinput"===o.kind?(i.label=o.label||`microphone ${n.audioinput.length+1}`,n.audioinput.push(i)):"audiooutput"===o.kind?(i.label=o.label||`speaker ${n.audiooutput.length+1}`,n.audiooutput.push(i)):"videoinput"===o.kind?(i.label=o.label||`camera ${n.videoinput.length+1}`,n.videoinput.push(i)):(i.label=o.label||`other ${n.other.length+1}`,n.other.push(i))}return n}(await async function(){return await navigator.mediaDevices.enumerateDevices()}())};const w=t;return n.default})()}));
//# sourceMappingURL=QencodeWebRTC.min.js.map