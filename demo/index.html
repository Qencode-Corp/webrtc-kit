<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.13.1/underscore-min.js" integrity="sha512-ZuOjyqq409+q6uc49UiBF3fTeyRyP8Qs0Jf/7FxH5LfhqBMzrR5cwbpDA4BgzSo884w6q/+oNdIeHenOqhISGw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
    <link rel="stylesheet" href="css/main.css">
    <title>WebRTC Demo</title>
</head>

<body>
    <div class="container">
        <h1>Client webcam</h1>
    
        <video id="userCam" autoplay playsinline muted></video>

        <div class="web-socket-url">
          <label>Server URL: </label>
          <input id="webSocketUrl" type="text" value="">  
        </div>
        
        <div>
            <button id="connect">Start Stream</button>
            <button id="disconect" class="stop" style="display: none;">Stop Stream</button>        
        </div>        

        <p id='log'></p>    
        <p id='errorMsg'></p>        
    </div>   

    <script src="./js/QencodeWebRTC.min.js"></script>
    <script>

        // display video on page load
        const constraints = window.constraints = {
        audio: true,
        video: true
        };

        function handleSuccess(stream) {
            const video = document.querySelector('#userCam');
            const videoTracks = stream.getVideoTracks();
            console.log('Got stream with constraints:', constraints);
            console.log(`Using video device: ${videoTracks[0].label}`);
            let log = document.querySelector('#log');
            log.innerHTML = `Using video device: ${videoTracks[0].label}`
            window.stream = stream; // make variable available to browser console
            video.srcObject = stream;

            // ready to initiate peer connection and start streaming
            enableStreaming(stream)
        }

        function handleError(error) {
        if (error.name === 'ConstraintNotSatisfiedError') {
            const v = constraints.video;
            errorMsg(`The resolution ${v.width.exact}x${v.height.exact} px is not supported by your device.`);
        } else if (error.name === 'PermissionDeniedError') {
            errorMsg('Permissions have not been granted to use your camera and ' +
            'microphone, you need to allow the page access to your devices in ' +
            'order for the demo to work.');
        }
        errorMsg(`getUserMedia error: ${error.name}`, error);
        }

        function errorMsg(msg, error) {
        const errorElement = document.querySelector('#errorMsg');
        errorElement.innerHTML += `<p>${msg}</p>`;
        if (typeof error !== 'undefined') {
            console.log(error);
        }
        }

        async function init() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                handleSuccess(stream);
            } catch (error) {
                handleError(error);
            }
        }

        function enableStreaming(stream){
            console.log("User video is ready")
        }

        init()


        // streaming
        let qencodeWebRTC = QencodeWebRTC.create();

        qencodeWebRTC.attachMedia(document.getElementById('userCam'));    

        let connectBtn = document.querySelector('#connect')
        let disconnectBtn = document.querySelector('#disconect')   
             
        connectBtn.addEventListener('click', () => {
            
            connectBtn.style.display = "none";
            disconnectBtn.style.display = "block";

            qencodeWebRTC.getUserMedia({
                audio: true,
                video: true
            }).then(function (stream) {

                let webSocketUrl = "" 

                let clientWebSocketUrl = document.getElementById('webSocketUrl').value
                console.log("clientWebSocketUrl: ", clientWebSocketUrl)

                if(clientWebSocketUrl){
                    webSocketUrl = clientWebSocketUrl
                }                   

                // Set WebRTC Provider URL
                qencodeWebRTC.startStreaming(webSocketUrl)

            });                

        })      
        
        disconnectBtn.addEventListener('click', () => {
            connectBtn.style.display = "block";
            disconnectBtn.style.display = "none";     

            qencodeWebRTC.remove();        
            init()
        })                   

    </script>
</body>

</html>